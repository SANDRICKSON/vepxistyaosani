from flask import render_template, redirect, url_for, flash, request
from flask_login import login_user, logout_user, current_user, login_required
from werkzeug.security import check_password_hash, generate_password_hash
from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadTimeSignature
from itsdangerous import URLSafeTimedSerializer
from flask_mail import Message
from extensions import app, mail
from models import User
from forms import RegisterForm, MessageForm, LoginForm, UpdateForm, ForgotPasswordForm,ResetPasswordForm
from datetime import datetime


import pytz

georgia_tz = pytz.timezone("Asia/Tbilisi")
local_time = current_user.last_login.astimezone(georgia_tz)
formatted_time = local_time.strftime('%Y-%m-%d %H:%M:%S')
# ğŸ“Œ Email áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ¢áƒáƒ™áƒ”áƒœáƒ˜áƒ¡ áƒ’áƒ”áƒœáƒ”áƒ áƒáƒªáƒ˜áƒ
s = URLSafeTimedSerializer(app.config['SECRET_KEY'])

# ğŸ“Œ áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒáƒ¦áƒ“áƒ’áƒ”áƒœáƒ˜áƒ¡ áƒ áƒáƒ£áƒ¢áƒ˜
@app.route('/forgot_password', methods=['GET', 'POST'])
def forgot_password():
    form = ForgotPasswordForm()
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()
        if user:
            token = s.dumps(user.email, salt='password-reset')
            reset_url = url_for('reset_password', token=token, _external=True)
            msg = Message('áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒáƒ¦áƒ“áƒ’áƒ”áƒœáƒ', recipients=[user.email])
            msg.body = f"áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒáƒ¦áƒ¡áƒáƒ“áƒ’áƒ”áƒœáƒáƒ“ áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ”áƒ— áƒáƒ› áƒ‘áƒ›áƒ£áƒšáƒ¡: {reset_url}"
            mail.send(msg)
            flash('áƒ”áƒš.áƒ¤áƒáƒ¡áƒ¢áƒ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ!', 'success')
            return redirect(url_for('login'))
        else:
            flash('áƒáƒ› áƒ”áƒš.áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒáƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ.', 'danger')
    return render_template('forgot_password.html', form=form, title="áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒáƒ¦áƒ“áƒ’áƒ”áƒœáƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

# ğŸ“Œ áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒáƒ£áƒ¢áƒ˜
@app.route('/reset_password/<token>', methods=['GET', 'POST'])
def reset_password(token):
    try:
        email = s.loads(token, salt='password-reset', max_age=3600)  # 1 áƒ¡áƒáƒáƒ—áƒ˜
    except (SignatureExpired, BadTimeSignature):
        flash('áƒ‘áƒ›áƒ£áƒšáƒ˜ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ áƒáƒœ áƒ•áƒáƒ“áƒ áƒ’áƒáƒ£áƒ•áƒ˜áƒ“áƒ!', 'danger')
        return redirect(url_for('forgot_password'))

    user = User.query.filter_by(email=email).first()
    if not user:
        flash('áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ!', 'danger')
        return redirect(url_for('forgot_password'))

    form = ResetPasswordForm()
    if form.validate_on_submit():
        user.password = generate_password_hash(form.password.data)
        db.session.commit()
        flash('áƒáƒáƒ áƒáƒšáƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ!', 'success')
        return redirect(url_for('login'))

    return render_template('reset_password.html', form=form)

@app.errorhandler(500)
def internal_error(error):
    return render_template('500.html', title="áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜"), 500



def send_verification_email(user_email):
    token = generate_verification_token(user_email)
    confirm_url = url_for('confirm_email', token=token, _external=True)
    subject = "Email Verification"
    message_body = f"áƒ›áƒáƒ’áƒ”áƒ¡áƒáƒšáƒ›áƒ”áƒ‘áƒ˜áƒ—, {user.username}! ğŸ˜Š\n\náƒ›áƒáƒ“áƒšáƒáƒ‘áƒ, áƒ áƒáƒ› áƒ“áƒáƒ˜áƒœáƒ¢áƒ”áƒ áƒ”áƒ¡áƒ“áƒ˜áƒ— áƒ©áƒ”áƒ›áƒ˜ áƒáƒ áƒáƒ”áƒ¥áƒ¢áƒ˜áƒ—. áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ¨áƒ”áƒ˜áƒ¥áƒ›áƒœáƒ! áƒ’áƒ—áƒ®áƒáƒ•áƒ—, áƒ’áƒáƒ˜áƒáƒ áƒ”áƒ— áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ‘áƒ›áƒ£áƒšáƒ–áƒ”:\n\n{confirm_url}\n\náƒ›áƒáƒ“áƒšáƒáƒ‘áƒ áƒ§áƒ£áƒ áƒáƒ“áƒ¦áƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡! ğŸ™Œ"



    msg = Message(
        subject=subject,
        recipients=[user_email],
        body=message_body,
        sender="vepkkhistyaosaniproject@gmail.com"  # âœ… áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ’áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜!
    )

    mail.send(msg)
def generate_verification_token(email):
    serializer = URLSafeTimedSerializer(app.config['SECRET_KEY'])
    return serializer.dumps(email, salt='email-confirm')

def confirm_verification_token(token, expiration=3600):
    serializer = URLSafeTimedSerializer(app.config['SECRET_KEY'])
    try:
        email = serializer.loads(token, salt='email-confirm', max_age=expiration)
    except:
        return False
    return email

# ğŸ“Œ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ˜áƒ›áƒ”áƒ˜áƒšáƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ
def send_verification_email(user_email):
    token = generate_verification_token(user_email)
    confirm_url = url_for('confirm_email', token=token, _external=True)
    subject = "Email Verification"
    message_body = f"áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ”áƒ— áƒáƒ› áƒ‘áƒ›áƒ£áƒšáƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ”áƒ›áƒáƒ˜áƒšáƒ˜áƒ¡ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡: {confirm_url}"

    msg = Message(subject=subject, recipients=[user_email], body=message_body)
    mail.send(msg)

# ğŸ“Œ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ‘áƒ›áƒ£áƒšáƒ˜áƒ¡ áƒ“áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ
@app.route('/confirm/<token>')
def confirm_email(token):
    email = confirm_verification_token(token)
    if not email:
        flash("áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ‘áƒ›áƒ£áƒšáƒ˜ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ áƒáƒœ áƒ•áƒáƒ“áƒ áƒ’áƒáƒ£áƒ•áƒ˜áƒ“áƒ!", "danger")
        return redirect(url_for('login'))

    user = User.query.filter_by(email=email).first()
    if user and not user.is_verified:
        user.is_verified = True
        user.save()
        flash("áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ”áƒ›áƒáƒ˜áƒšáƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒªáƒ˜áƒ áƒ“áƒ!", "success")
    elif user and user.is_verified:
        flash("áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ”áƒ›áƒáƒ˜áƒšáƒ˜ áƒ£áƒ™áƒ•áƒ” áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒªáƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!", "info")

    return redirect(url_for('login'))

@app.route("/admin/users")
@login_required
def view_users():
    if current_user.username == "sandroqatamadze":
        users = User.query.all()
        return render_template("admin_users.html", users=users, title="áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ®áƒ˜áƒšáƒ•áƒ")
    else:
        flash("Sorry, you are not authorized to view this page.")
        return redirect(url_for('noadmin'))

@app.route("/403")
@login_required
def noadmin():
    return render_template("403.html", title="áƒáƒ™áƒ áƒ«áƒáƒšáƒ£áƒšáƒ˜ áƒ¬áƒ•áƒ“áƒáƒ›áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/admin")
@login_required
def admin():
    if current_user.username == "sandroqatamadze":
        return render_template("admin.html", title="áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡ áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")
    else:
        flash("Sorry but you are not the admin")
        return redirect(url_for('noadmin'))

@app.errorhandler(404)
def page_not_found(error):
    return render_template('404.html', title="404 - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜"), 404

@app.route("/")
def index():
    return render_template("index.html", title="áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/update", methods=["GET", "POST"])
def update():
    form = UpdateForm()
    if form.validate_on_submit():
        print(form.update.data)
    return render_template("update.html", form=form, title="áƒ’áƒáƒáƒ’áƒ áƒ«áƒ”áƒšáƒ” - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/about")
def about():
    return render_template("about.html", title="áƒáƒ áƒáƒ”áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/contact", methods=["GET", "POST"])
def contact():
    form = MessageForm()
    if form.validate_on_submit():
        print(form.message.data)
    return render_template("contact.html", form=form, title="áƒ™áƒáƒœáƒ¢áƒáƒ¥áƒ¢áƒ˜ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/author")
def author():
    return render_template("author.html", title="áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

# ğŸ“Œ áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ áƒáƒ£áƒ¢áƒ˜ - áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒªáƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
@app.route("/login", methods=["GET", "POST"])
def login():
    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first()
        if user and check_password_hash(user.password, form.password.data):
            if not user.is_verified:
                send_verification_email(user.email)  # áƒ®áƒ”áƒšáƒáƒ®áƒáƒšáƒ˜ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ
                flash("áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒáƒ–áƒ” áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ‘áƒ›áƒ£áƒšáƒ˜ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ!", "warning")
                return redirect(url_for('login'))
            
            login_user(user, remember=True)  # âœ… áƒ¡áƒ”áƒ¡áƒ˜áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ
            user.update_last_login()  # âœ… áƒ‘áƒáƒšáƒ áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒ‘áƒ˜áƒ¡ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ
            return redirect(url_for("index")) 
    
    return render_template("login.html", form=form, title="áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route("/admin/sessions")
@login_required
def admin_sessions():
    if current_user.username != "sandroqatamadze":
        flash("áƒ—áƒ¥áƒ•áƒ”áƒœ áƒáƒ  áƒ’áƒáƒ¥áƒ•áƒ— áƒ¬áƒ•áƒ“áƒáƒ›áƒ!", "danger")
        return redirect(url_for("index"))

    users = User.query.filter(User.last_login >= datetime.utcnow() - timedelta(minutes=30)).all()
    return render_template("admin_sessions.html", users=users)



@app.route("/poem")
def poem():
    return render_template("poem.html", title="áƒáƒáƒ”áƒ›áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('index'))

@app.route("/profile")
@login_required
def profile():
    return render_template("profile.html", title="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

# ğŸ“Œ áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ áƒáƒ£áƒ¢áƒ˜ - áƒ”áƒ›áƒáƒ˜áƒšáƒ˜áƒ¡ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒ—
@app.route("/register", methods=["GET", "POST"])
def register():
    form = RegisterForm()
    if form.validate_on_submit():
        user = User(
            username=form.username.data,
            email=form.email.data,
            password=form.password.data,
            birthday=form.birthday.data,
            country=form.country.data,
            gender=form.gender.data,
            is_verified=False
        )
        user.create()
        send_verification_email(user.email)
        flash("áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒáƒ–áƒ” áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ‘áƒ›áƒ£áƒšáƒ˜!", "info")
        return redirect(url_for("login"))
    
    print(form.errors) 
    return render_template("register.html", form=form, title="áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")


@app.route("/privacy")
def privacy():
    return render_template("privacy.html", title="áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ - áƒ•áƒ”áƒ¤áƒ®áƒ˜áƒ¡áƒ¢áƒ§áƒáƒáƒ¡áƒáƒœáƒ˜")

if __name__ == "__main__":  
    app.run(debug=True)
